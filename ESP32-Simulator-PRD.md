# PRD: Эмулятор ESP32-устройства для Node-RED

## 1. Обзор проекта

Создание кастомной ноды для Node-RED, которая эмулирует многофункциональное устройство на базе ESP32, взаимодействующее через MQTT согласно предоставленной документации системы команд. Эмулятор будет работать с существующим MQTT-брокером Mosquitto, настроенным на анонимные подключения.

## 2. Цели и задачи

Основная цель - разработать ноду, которая полностью имитирует работу ESP32-устройства с поддержкой всех функций, описанных в системе команд, включая:
- Прием команд через MQTT
- Отправку статусов и телеметрии
- Имитацию различных компонентов устройства
- Генерацию событий на основе настроек пользователя

## 3. Функциональные возможности

Эмулятор будет имитировать:
- RFID-считыватель (генерация событий считывания меток)
- Адресное светодиодное кольцо (~24 LED)
- Внешнюю адресную светодиодную ленту
- Два релейных выхода с поддержкой PulseTime
- Два цифровых входа с настраиваемыми параметрами
- Отслеживание состояния питания
- Системные функции (статус, перезагрузка)
- Поддержку GPIO-портов
- Bluetooth-функциональность

## 4. Архитектура решения

1. **Node-RED кастомная нода**:
   - Графический интерфейс для настройки параметров эмулятора
   - Интеграция с существующими MQTT-нодами Node-RED
   - Эмуляция внутренних компонентов устройства

2. **MQTT интеграция**:
   - Подписка на топики вида `cmnd/<location>/<device_type>/<device_id>/#`
   - Публикация в топики `stat/...` и `tele/...`
   - Поддержка QoS 1 и Retain флагов для соответствующих сообщений

3. **Конфигурация**:
   - Настройка топика (`<location>`, `<device_type>`, `<device_id>`)
   - Задание начальных параметров устройства
   - Настройка симуляции событий (автоматическая генерация событий)

## 5. Технические детали реализации

1. **Структура проекта Node-RED ноды**:
   - `package.json` - метаданные ноды
   - `esp32-simulator.js` - серверная логика
   - `esp32-simulator.html` - интерфейс настройки
   - `icons/` - графические элементы

2. **Логика эмулятора**:
   - Эмуляция всех модулей согласно документации
   - Поддержка всех команд и генерация соответствующих ответов
   - Сохранение состояния между перезапусками
   - Работа через стандартные MQTT-ноды Node-RED

3. **Генерация событий**:
   - Настраиваемая генерация RFID-событий
   - Симуляция изменения состояний входов
   - Эмуляция Bluetooth-обнаружений
   - Периодическая телеметрия питания

## 6. Пользовательский интерфейс

1. **Конфигурация ноды**:
   - Базовые настройки (ID, тип устройства, расположение)
   - Настройка MQTT-брокера (использование существующих нод)
   - Настройки симуляции

2. **Рабочий процесс**:
   - Нода имеет входы для управления симуляцией
   - Выходы для передачи сгенерированных событий
   - Может работать автономно, генерируя события по расписанию

## 7. План разработки

1. **Этап 1**: Базовая структура ноды
   - Создание шаблона ноды
   - Интеграция с MQTT через существующие Node-RED ноды
   - Настройка конфигурации

2. **Этап 2**: Реализация основных функций
   - Реле и цифровые входы
   - Светодиоды
   - RFID

3. **Этап 3**: Реализация дополнительных функций
   - GPIO
   - Bluetooth
   - Системные функции

4. **Этап 4**: Автоматическая генерация событий
   - Настраиваемые параметры генерации
   - Логика симуляции разных событий
   - Тестирование различных сценариев

5. **Этап 5**: Документация и оптимизация
   - Руководство пользователя
   - Примеры потоков Node-RED

## 8. Зависимости и требования

- Node-RED (версия 1.0 или выше)
- MQTT-брокер Mosquitto (анонимные подключения)
- Node.js (версия 12 или выше)
- Корректно настроенные MQTT-ноды в Node-RED

## 9. Ограничения и допущения

- Эмулятор не реализует физический уровень устройства
- Не требуется эмуляция ошибок и нестабильностей реального устройства
- Нет необходимости в отдельном веб-интерфейсе, все настройки производятся через стандартный интерфейс Node-RED 